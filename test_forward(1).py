# prompt = "In the modern world, technology plays an essential role in shaping daily life. It has transformed how individuals communicate, access information, and even perceive the world around them. From smartphones to the internet, technological innovations have become so deeply integrated into society that it's hard to imagine life without them. While these advancements have made life easier and more convenient in many ways, they have also led to significant changes in various spheres of human existence, including social structures, the economy, and personal well-being. The rapid growth of technology over the past few decades has reshaped nearly every aspect of life. From the way people work to how they learn, technology has had an undeniable influence on the structure of society. For instance, digital devices such as smartphones and tablets have revolutionized the way individuals access information. The internet has connected people globally in ways that were previously unimaginable, allowing for real-time communication and interaction. Social media platforms have brought about a new era of connectivity, enabling individuals to maintain relationships across vast distances. However, this widespread use of technology also raises questions about privacy, security, and the potential negative effects of constant connectivity. One of the most significant impacts of technology is its effect on communication. In the past, communication was limited to face-to-face interactions or written correspondence. However, the advent of the internet and mobile technologies has made it possible to communicate with others instantaneously, regardless of location. Social media platforms, messaging apps, and video conferencing software have made it easier than ever to stay connected with family, friends, and colleagues. While this increased connectivity has fostered stronger global communities, it has also introduced new challenges. For example, the rise of online platforms has led to an increase in cyberbullying, harassment, and misinformation. Additionally, the overuse of digital communication can sometimes lead to a sense of isolation or emotional detachment from real-life interactions. Another area in which technology has had a profound impact is education. Online learning platforms, virtual classrooms, and digital resources have transformed how people acquire knowledge. Traditional brick-and-mortar schools have incorporated technology into their teaching methods, enhancing the learning experience for students. Access to online courses and educational tools has democratized education, enabling individuals from diverse backgrounds to pursue knowledge and skills that were once out of reach. Technology has also facilitated more personalized learning experiences, allowing students to learn at their own pace and according to their own needs. However, despite the many benefits, there are concerns about the potential drawbacks of technology in education. For instance, the over-reliance on digital devices may lead to a decline in face-to-face social interactions, and some argue that technology could exacerbate existing educational inequalities, especially for those without access to the necessary resources. In the workplace, technology has revolutionized the way people work and conduct business. The rise of automation, artificial intelligence, and data analytics has streamlined processes, improved productivity, and opened up new opportunities for innovation. Many industries have embraced these technologies to enhance efficiency, reduce costs, and improve customer experiences. For example, industries such as healthcare, manufacturing, and logistics have benefited from technological advancements, allowing for more precise medical treatments, faster production processes, and more effective supply chain management. At the same time, there are concerns about the impact of automation on jobs. As machines and algorithms replace human labor in various industries, many fear that widespread unemployment could result. Moreover, the increasing reliance on technology in the workplace has raised questions about worker privacy, data security, and the ethical use of artificial intelligence. While technology has brought numerous benefits, it has also introduced several challenges. One of the most pressing issues is the impact of technology on mental health and well-being. The constant use of digital devices, social media, and other technologies can lead to feelings of stress, anxiety, and depression. Studies have shown that excessive screen time can negatively affect sleep patterns, increase feelings of loneliness, and contribute to a range of mental health problems. Furthermore, the pressure to maintain a curated online persona can lead to unrealistic expectations and a distorted sense of self-worth. For many individuals, the constant barrage of information from social media, news outlets, and other digital platforms can be overwhelming, leading to a phenomenon known as information overload. As society becomes increasingly reliant on technology, finding ways to mitigate its negative effects on mental health will be crucial. The rise of technology has also had significant economic implications. On one hand, technological advancements have driven economic growth by creating new industries, jobs, and markets. The technology sector itself has become one of the largest and most profitable industries in the world, with companies like Apple, Google, and Amazon leading the way in terms of innovation and profitability. On the other hand, the increasing reliance on technology has led to growing concerns about the concentration of wealth and power in the hands of a few large corporations. The dominance of tech giants has raised questions about monopolies, competition, and the ethical responsibility of these companies. Additionally, the rapid pace of technological change has created a growing divide between those who have access to the latest innovations and those who do not, further exacerbating existing social and economic inequalities. Looking to the future, the relationship between technology and society will continue to evolve. Innovations such as artificial intelligence, biotechnology, and renewable energy have the potential to revolutionize various aspects of life. While these technologies promise to bring about significant advancements, they also raise important ethical questions. For instance, the development of autonomous vehicles and AI-driven systems has sparked debates about safety, accountability, and the potential for unintended consequences. Similarly, advancements in biotechnology, such as gene editing and cloning, have raised concerns about the ethical implications of manipulating the human genome. As technology continues to advance, it will be essential for society to carefully consider the ethical, legal, and social implications of these innovations. Ultimately, the future of technology and its impact on society will depend on how it is used and regulated. While technology has the potential to improve lives and solve some of the world’s most pressing problems, it also carries risks that must be carefully managed. As individuals, organizations, and governments work to harness the power of technology, it will be important to ensure that its benefits are distributed equitably and that its negative effects are minimized. By taking a thoughtful and responsible approach to technological development, society can unlock the full potential of innovation while addressing its challenges and ensuring a sustainable and equitable future for all."
# prompt += "As we look further into the future, it becomes clear that technology will continue to shape society in ways both expected and unexpected. The rapid pace of change means that individuals and societies must adapt quickly to new developments, which can sometimes be overwhelming. The challenge lies not just in embracing technological innovations, but in doing so in a way that benefits all members of society, and not just those with access to the latest tools or resources. One of the key areas where technology could have a transformative impact is in the field of healthcare. Advancements in medical technology, such as precision medicine, gene therapy, and robotic surgeries, have the potential to drastically improve the quality and accessibility of healthcare services. The rise of wearable health devices and telemedicine has already begun to revolutionize patient care, enabling individuals to monitor their health in real-time and access medical consultations remotely. These innovations could lead to more personalized treatments, quicker diagnoses, and a reduction in the overall cost of healthcare. However, the implementation of such technologies also presents a number of challenges, particularly in terms of privacy, data security, and equitable access. As healthcare becomes increasingly digital, ensuring that sensitive health information is protected and that all individuals have equal access to the benefits of these technologies will be critical. Another emerging technology that promises to have a significant impact on society is artificial intelligence (AI). AI has the potential to revolutionize numerous industries, from healthcare to finance to entertainment. In healthcare, AI algorithms can analyze medical images, assist in diagnosing diseases, and even recommend personalized treatment plans based on a patient’s genetic makeup. In finance, AI can improve the accuracy of predictions, optimize investments, and detect fraudulent activities. In entertainment, AI-powered recommendation systems help users discover new content tailored to their preferences. However, while AI offers many exciting possibilities, it also raises important questions about ethics, privacy, and the future of work. The increasing use of AI in decision-making processes could lead to biased outcomes if the algorithms are not properly designed or tested. Moreover, the automation of certain tasks through AI could displace human workers, leading to job losses and economic instability. Therefore, it is essential to develop frameworks that ensure AI is used ethically and responsibly, with appropriate safeguards to mitigate its potential harms. The digital divide is another pressing issue in the age of technology. While technological advancements have undoubtedly improved lives for many, there are still significant gaps in access to technology, particularly in developing countries or marginalized communities. The lack of access to the internet, digital devices, and other technological resources can create barriers to education, employment, and healthcare. In some parts of the world, the digital divide is widening, as people without access to technology are left behind in an increasingly digital society. Bridging this gap will require significant investments in infrastructure, education, and policy changes to ensure that everyone, regardless of their geographic location or socioeconomic status, can benefit from the opportunities that technology provides. One of the most profound ways in which technology is affecting society is by changing the way we think about privacy. The digital age has brought about a significant shift in how personal data is collected, stored, and used. Social media platforms, online retailers, and even government agencies gather vast amounts of data about individuals, from browsing habits to location information to personal preferences. While this data can be used to improve services and create personalized experiences, it also raises concerns about surveillance, data breaches, and the potential misuse of personal information. The question of who owns personal data and how it should be protected is one that will continue to be debated in the years to come. As society becomes more aware of the risks associated with data collection, there will likely be increased calls for stronger privacy laws and more transparent data practices. Ensuring that individuals retain control over their personal information and that it is used responsibly will be one of the most important challenges in the digital age. Furthermore, technology has the potential to influence culture and society in profound ways. In many ways, it has brought the world closer together, breaking down geographical and cultural barriers. For example, the internet has allowed individuals from different cultures and backgrounds to interact, share ideas, and collaborate in ways that were not possible before. Social media platforms, video-sharing websites, and online forums have created global communities where people can connect based on shared interests and values. This interconnectedness has facilitated the exchange of ideas, increased cultural awareness, and even spurred social movements. However, it has also led to challenges related to identity, authenticity, and the spread of misinformation. The rise of fake news, deepfakes, and other forms of digital manipulation has created a new era of information warfare, where it can be difficult to discern fact from fiction. The rapid spread of misinformation can have serious consequences, from influencing elections to inciting violence, and addressing this issue will require a collective effort from governments, tech companies, and individuals. While the social and cultural impact of technology is vast, its environmental impact is equally significant. As technology continues to advance, the demand for energy, raw materials, and manufacturing resources increases. The production of electronic devices, data centers, and communication networks requires a substantial amount of energy and materials, much of which comes from non-renewable resources. The disposal of electronic waste, such as old smartphones and computers, has become a growing concern, as these devices often contain hazardous chemicals that can contaminate the environment. Moreover, the carbon footprint of technology, particularly in terms of energy consumption and data transmission, contributes to global warming and climate change. However, technology also holds the potential to address these environmental challenges. Innovations such as renewable energy technologies, energy-efficient devices, and smart grids can help reduce the environmental impact of technology. As the world continues to grapple with climate change, it will be crucial to develop sustainable technologies that minimize harm to the planet while still advancing progress. In conclusion, the impact of technology on society is undeniable, and its influence will only continue to grow in the coming years. While technology offers immense potential to improve lives, drive economic growth, and address global challenges, it also presents a number of risks and challenges that must be carefully managed. As society continues to evolve in the digital age, it will be essential to strike a balance between embracing innovation and addressing the ethical, social, and environmental concerns that accompany it. By fostering a responsible approach to technology, we can ensure that it serves the common good and contributes to a more equitable and sustainable future for all."
# prompt += "As we delve deeper into the relationship between technology and society, it’s clear that technology is not just a tool, but a reflection of the values, priorities, and ambitions of the societies that create and use it. The ways in which technology is developed, regulated, and adopted are all influenced by the cultural, economic, and political contexts in which it exists. This means that while technology has the potential to improve lives, its impact is not always uniform. Different societies and communities may experience the benefits and challenges of technology in vastly different ways, depending on their access to resources, their cultural attitudes toward innovation, and their governance structures. One of the most significant ways in which technology reflects societal values is through its role in shaping the economy. Technology has fundamentally altered how businesses operate, how consumers make decisions, and how wealth is generated. The rise of the digital economy, powered by the internet, e-commerce, and digital platforms, has transformed industries ranging from retail to entertainment to finance. Startups and tech giants such as Uber, Airbnb, and Amazon have disrupted traditional business models, creating new economic opportunities but also posing challenges to existing workers and industries. The gig economy, for example, has been facilitated by technology, allowing individuals to work flexibly and remotely. However, this has also led to concerns about job security, labor rights, and the erosion of traditional employment benefits such as health insurance and retirement savings. As the economy becomes increasingly digitized, questions about fairness, workers' rights, and income inequality will only become more pressing. Technology also plays a central role in shaping global politics. In recent years, the rise of social media and digital platforms has transformed the way political campaigns are run, the way people engage with political content, and the way information is shared and consumed. Political movements that were once confined to local or national borders are now able to gain global traction, thanks to the reach of social media. For instance, the Arab Spring, which began in Tunisia in 2010, was fueled in part by the power of social media to mobilize protestors and spread information. On the other hand, the use of social media for political purposes has also given rise to new challenges. The spread of fake news, misinformation, and targeted political ads on platforms like Facebook and Twitter has raised concerns about the integrity of democratic processes. Governments are increasingly grappling with how to regulate online content, balance free speech, and protect individuals from digital manipulation. The role of technology in politics is a double-edged sword, offering opportunities for greater participation and engagement but also creating vulnerabilities that must be addressed. Moreover, the ethical implications of technology in politics are becoming more pronounced, particularly as artificial intelligence and machine learning algorithms play a larger role in decision-making processes. AI is being used to analyze vast amounts of data and predict outcomes in everything from political elections to social policy. While these technologies can improve efficiency and help create data-driven policies, they also raise concerns about bias and accountability. If AI systems are not properly designed, they can perpetuate existing social inequalities, making decisions that disproportionately affect marginalized communities. The challenge, therefore, is not just to embrace new technologies but to ensure that they are developed and used in ways that are transparent, fair, and equitable. As societies become more reliant on digital technologies in politics, the importance of ethical governance and public oversight will only grow. The education sector, too, is being reshaped by technology in profound ways. Traditional educational systems, which have long been built on face-to-face interactions and standardized testing, are gradually being replaced by more flexible, technology-driven models. Online learning platforms, massive open online courses (MOOCs), and virtual classrooms are allowing individuals to learn at their own pace, from anywhere in the world. For many, this shift has opened up new opportunities for education that were previously out of reach. In countries with limited access to traditional schools, online education is helping bridge the gap, giving students access to high-quality resources that would otherwise be unavailable. However, the rise of digital learning has also led to concerns about its effectiveness, particularly in terms of student engagement, teacher-student relationships, and the quality of education. Some argue that online education, while convenient, may lack the personal connection and mentorship that comes with in-person learning. Additionally, the digital divide continues to be a significant issue, as students in low-income areas or rural regions may not have access to the devices or internet connectivity necessary to fully participate in digital learning. To address these challenges, education systems must ensure that technology is integrated in a way that complements traditional methods and promotes inclusivity for all learners. Looking beyond the immediate future, the possibilities for technological advancement seem almost limitless. Breakthroughs in fields like quantum computing, biotechnology, and space exploration could redefine what is possible for humanity. For example, quantum computers, which are still in the early stages of development, have the potential to solve complex problems that are currently beyond the capabilities of classical computers. This could lead to advancements in fields such as cryptography, drug discovery, and climate modeling. Similarly, progress in biotechnology, including gene editing and personalized medicine, could revolutionize healthcare by enabling more precise and effective treatments for diseases like cancer, Alzheimer's, and genetic disorders. Space exploration, with missions to Mars and beyond, could offer humanity new frontiers to explore, potentially leading to the colonization of other planets and the discovery of extraterrestrial life. However, the potential benefits of these technological advancements come with their own set of risks and ethical dilemmas. As technology continues to push the boundaries of what is possible, society will need to carefully consider the long-term consequences of its actions. For example, advancements in biotechnology could lead to significant medical breakthroughs, but they also raise concerns about genetic manipulation and the potential for “designer babies.” Space exploration could expand humanity’s reach beyond Earth, but it also raises questions about the ethical implications of exploiting other planets and the potential environmental impact of space travel. The role of ethics in the development of future technologies will be crucial, as society must decide not only what can be done but also what should be done. As we move further into the 21st century, the pace of technological change is only expected to accelerate. The key to navigating this rapidly evolving landscape will be to approach technology with a sense of responsibility and foresight. While the potential for progress is vast, it is equally important to be mindful of the challenges and risks that technology brings. By focusing on creating ethical frameworks, ensuring equitable access, and fostering sustainable innovation, society can harness the power of technology to improve lives while safeguarding the future of the planet and its inhabitants."
# prompt += "As we reflect on the continued development of technology, it is essential to recognize that the rate at which these changes are occurring can be both exhilarating and overwhelming. On the one hand, technology has introduced conveniences and improvements to the lives of millions, and in some cases, it has reshaped entire industries, creating new opportunities that previously didn’t exist. On the other hand, it is clear that these rapid advancements are not without their challenges and unintended consequences. This dual nature of technology—offering both promise and risk—underscores the need for careful and thoughtful planning, regulation, and reflection as we move forward."
# prompt += "One aspect of technology that will become increasingly important in the years to come is its relationship with environmental sustainability."


from collections import Counter
from datasets import load_dataset
from transformers import (
    AutoConfig,
    AutoModel,
    AutoModelForCausalLM,
    AutoModelForSequenceClassification,
    AutoTokenizer,
)
import torch

def effective_rank(Z, alpha=0.99):
    Z = Z.to(torch.float32)

    singular_values = torch.linalg.svdvals(Z)
    singular_values_squared = singular_values ** 2
    
    total_energy = torch.sum(singular_values_squared)
    cumulative_energy = torch.cumsum(singular_values_squared, dim=0)
    
    k = torch.searchsorted(cumulative_energy / total_energy, alpha).item() + 1
    return k
    


model_name = "meta-llama/Meta-Llama-3-8B"
config = AutoConfig.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(
        model_name,
        device_map='auto',
        config=config,
        torch_dtype=torch.float16,
    )
for n,p in model.named_parameters():
    print(n, p.shape)
tokenizer = AutoTokenizer.from_pretrained(model_name, use_fast=False, trust_remote_code=True)
import json
with open("/root/workspace/cthu1g4p420c73egakcg/BCD-Benchmarks/datasets/GSM8K/train.json", 'r', encoding="utf-8") as f:
    data = json.load(f)
# print(data[0])
cnt = 0
prompt = ""
for d in data:
    prompt += d['instruction'] + '\n' + d['output'] + '\n\n'
    cnt += 1
    if cnt == 24:
        break

inputs = tokenizer(prompt, return_tensors="pt").to(model.device)

input_ids = inputs['input_ids'].squeeze(0) 
print(input_ids.shape)
token_counts = Counter(input_ids.tolist())
print("不同的token数量:", len(token_counts))

with torch.no_grad():  
    outputs = model(**inputs, labels=inputs["input_ids"],  output_hidden_states=True,)

logits = outputs.logits
# print(effective_rank(logits[0], 0.99))
# exit(0)
hidden_states = outputs.hidden_states
# print(hidden_states)
# print(len(hidden_states))
ranks = []
x = ['embed']
for layer_idx, hidden_state in enumerate(hidden_states):
    # print(f"Layer {layer_idx} shape: {hidden_state.shape}")
    # print(f"start {layer_idx}")
    w = hidden_state[0]
    w.to('cuda')
    # print(hidden_state.shape)
    # exit(0)
    # print(w.shape)
    rank = effective_rank(w, 0.99)
    print(f"layer{layer_idx} rank={rank}")
    ranks.append(rank)
    if layer_idx > 0:
        x.append(layer_idx)
    # print(f"finish {layer_idx}")
    # break
x.append("logits")
ranks.append(effective_rank(logits[0], 0.99))
print(x)
print(ranks)